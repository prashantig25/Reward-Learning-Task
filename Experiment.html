<!DOCTYPE html>
<html lang="en">
<head>
    <title>Expt_task2</title>
    <script src="js/jspsych.js"></script>
    <script src="js/jspsych-html-keyboard-response.js"></script>
    <script src="js/jspsych-canvas-keyboard-response.js"></script>
    <script src="js/jspsych-canvas-slider-response.js"></script>
    <script src="js/jspsych-survey-text.js"></script>
    <script src="js/additionals.js"></script>
    <link href="jspsych/css/jspsych.css" rel="stylesheet" type="text/css" />
</head>
<body></body>
<script>
var timeline = [];
var fix = {
        type: 'canvas-keyboard-response',
        stimulus: fixation,
        trial_duration: fix_dura,
        choices: jsPsych.NO_KEYS,
        data: { condition: 'fixation'},
        on_start: function () {
          document.body.style.cursor = "none";
        }
    };
var welcome = {
        type: "html-keyboard-response",
        stimulus: "<p style=\"font-size: 20px;color: #000000\"> Welcome to the study. </p> <p> Please make sure that you are participating in this study in a calm and comfortable environment. Please place your desktop screen at one-arm distance from your eyes. <br> There are instructions at every stage of the study. Please read and understand them carefully. <br> If you are running this study on Safari, please exit now and restart the study on any other browser (e.g. Chrome, Firefox, MS Edge). </p> <p> Press any key to process forward.</p>",
    };
var survey_id = {
        type: 'survey-text',
        questions:[
            {prompt: "Please enter your correct unique Prolific ID here.", name: 'Prolific_ID'}],
        button_label:'Next',
    };

var score = {
        type: 'html-keyboard-response',
        on_start: function(score){
            score.total = jsPsych.data.get().last(trialcounter).select('correct').sum()
        },
        stimulus:function () {
            var points = jsPsych.data.get().last(trialcounter).select('correct').sum() // adds all the points earned in the last n (trialcounter) number of trials to present total points at the end of the block.
            return `<p style=\"font-size: 25px;color: #000000\">You win <strong> ${points} </strong> points in this block. <br> You have completed <strong> ${counter} </strong> blocks out of 12 blocks of the experiment. Press a key to proceed forward.</p>`
        },
        on_finish: function(data) {
            data.finalscore = jsPsych.currentTrial().total // final score after each block
            trialcounter = 0 // trial counter resets to 0 after a block ends because the trialcounter counts the number of points in each block seperately
            index = 0 // index of rewards also resets to 0 after a block ends
            index_missed = 0
            index_mu = 0
            action_s0 = 0;
            action_s1 = 0;
            counter = counter + 1; // Increase the counter by one when a fresh block of trials start.
            s = shuffle(state);
        }
    };   
var fb = {
        type: "html-keyboard-response", choices: jsPsych.NO_KEYS, trial_duration: duration,
        stimulus: function () {
            var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
            if (last_trial_correct) {
                return "<p style=\"font-size: 30px;color: #016901\">You win 1 point!</p>";
            } else {
                return "<p style=\"font-size: 30px;color: #ba0000\">You win 0 points!</p>"
            }
        },
        on_finish: function(data) {
          //data.prompt_patch = shuffled_patch.pop()
          data.index = index_mu // index starts at 0
          var blocktype = jsPsych.data.get().last(2).values()[0].block
          if ( blocktype === 1 || blocktype === 2) {
            if (s_mu[data.index] === 0) { // state that the trial belongs to
                data.difference = randbet(high_min_neg, high_max_neg) // contrast differences for s = 0
            }
            else {
                data.difference = randbet(high_min, high_max)
            }
          }
          else {
              if (s_mu[data.index] === 0) { // state that the trial belongs to
                data.difference = randbet(low_min_neg, low_max_neg) // contrast differences for s = 0
              }
              else {
                data.difference = randbet(low_min, low_max)
              }
            }
          
          data.contrast_left = avgcon + data.difference // calculate the contrast for the left gabor based on this trial's difference
          data.contrast_right  = avgcon - data.difference
        }
    };
var firstblock = {
        type: "html-keyboard-response",
        stimulus: "<p style=\"font-size: 20px;color: #000000\"> The first block of trials will begin now. <br> The relationship between the contrast level of the images and reward may change now as compared to previous blocks. <br> Press a key when you are ready.</p>",
    };
var nextblock = {
        type: "html-keyboard-response",
        stimulus: "<p style=\"font-size: 20px;color: #000000\"> Next block begins now. <br> The relationship between the contrast level of the images and reward may change now as compared to previous blocks. <br> Press a key when you are ready.</p>",
    };
var completion_id = {
        type: 'survey-text',
        questions: [
            {prompt: "The completion code for this study is 88C1F9FF. Please enter this code here.", name: 'Completion_code'}],
    };
var mu_missed = {
      type: 'canvas-slider-response',
      trial_duration: 6000,
      canvas_size: [350, 500],
      data: {condition: 'mu_missed'},
      button_label: 'Next trial',
      //slider_start: 0,
      stimulus: gabor,
      require_movement: true,
      labels: ['0', '0.1','0.2', '0.3', '0.4', '0.5', '0.6', '0.7', '0.8', '0.9', '1'],
      on_start: function(mu_missed) {
            document.body.style.cursor = "auto";
            mu_missed.contrast_left = avgcon + jsPsych.data.get().last(1).values()[0].difference // calculate the contrast for the left gabor based on this trial's difference
            mu_missed.contrast_right  = avgcon - jsPsych.data.get().last(1).values()[0].difference
      },
      prompt: function () {
        var con_left = avgcon + jsPsych.data.get().last(1).values()[0].difference
        var con_right =  avgcon - jsPsych.data.get().last(1).values()[0].difference
        var trial_contrast = jsPsych.data.get().last(2).values()[0].contrast
        if (trial_contrast === 0) {
          if (con_left > con_right) {
              return " <p> If you choose the image on your right, what do you think is the probability of winning a reward? </p>"
            }
            else {
              return " <p> If you choose the image on your left, what do you think is the probability of winning a reward? </p>"
            }
        }
        else {
          if (con_left > con_right) {
              return " <p> If you choose the image on your left, what do you think is the probability of winning a reward? </p>"
            }
            else {
              return " <p> If you choose the image on your right, what do you think is the probability of winning a reward? </p>"
          }
        }
        },
      on_finish: function (data) {
            data.contrast_left = jsPsych.data.get().last(1).values()[0].contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.data.get().last(1).values()[0].contrast_right // stores the contrast level of right patch on this trial
            data.diff = jsPsych.data.get().last(1).values()[0].difference
            index_missed = index_missed + 1;
            data.state = s[jsPsych.currentTrial().index_mu]
        }
    };
var missed_trial = { // missed trial
        type: 'canvas-keyboard-response', //jsPsych trial type
        stimulus: gabor, // gabor drawn based on function
        data: {condition: 'missed'}, // condition of this trial
        choices: keys, response_ends_trial: false, trial_duration: duration,
        on_start: function(missed_trial) { // This part takes the first elements of the feedback and contrast parameters of the first missed trial.
            document.body.style.cursor = "none";
            missed_trial.missed_reward = missed_fb.shift() // stores the feedback for the first missed trial in the missed trial array
            missed_trial.contrast_left = missed_con.shift(); // stores the left contrast level for the first missed trial in the missed trial array
            missed_trial.contrast_right = missed_con1.shift(); // stores the right contrast level for the first missed trial in the missed trial array
            missed_trial.contrast = missed_contrast.shift();
            missed_trial.block = missed_block.shift()
        },
        on_finish: function (data) {
            if (data.response === jsPsych.currentTrial().missed_reward) {
                data.correct = true;
                //data.block = missed_block.shift();
                //data.contrast = missed_contrast.shift();
                missed.pop(); // Once the missed trial has been repeated and the participant has responded, the length of the missed array has to be reduced by 1.
            } else if (data.response === null) {
                missed.pop()
                missed.unshift(1) // Adds to the missed array when the participant fails to respond to a repeated trial.
                missed_fb.unshift(jsPsych.currentTrial().missed_reward),
                missed_con.unshift(jsPsych.currentTrial().contrast_left),
                missed_con1.unshift(jsPsych.currentTrial().contrast_right)
                missed_block.unshift(jsPsych.currentTrial().block)
                missed_contrast.unshift(jsPsych.currentTrial().contrast)
            }
            else {
                data.correct = false;
                missed.pop() // Once the missed trial has been repeated and the participant has responded, the length of the missed array has to be reduced by 1.
                //data.block = missed_block.shift();
                //data.contrast = missed_contrast.shift();
            }
            data.block = jsPsych.currentTrial().block
            data.contrast = jsPsych.currentTrial().contrast
            data.diff = jsPsych.currentTrial().difference // contrast difference
            data.corr_resp = jsPsych.currentTrial().missed_reward // Stores the correct response on the said trial.
            data.contrast_left = jsPsych.currentTrial().contrast_left // Stores the contrast of the left patch on the said trial.
            data.contrast_right = jsPsych.currentTrial().contrast_right // Stores the contrast of the rightt patch on the said trial.
            trialcounter = trialcounter + 4 // increases the trial counter to include fixation, actual trial and feedback. Thus, increases the counter by 3.
            data.stim = missed.length
            data.tcount = trialcounter
        },
    };
var missed_mixed = {timeline: [fix, missed_trial, fb, mu_missed], repetitions: 1} //full trial procedure of a missed trial
var missed_loop = {   // Runs the loop till the missed array has elements. Stops when the missed array is empty.
        timeline: [missed_mixed],
        loop_function: function() {
            if (missed.length === 0) {
                return false;
            } else {
                return true;
            }
        },
    };
var missed_conditional = { // first runs the conditional to check if the missed array has any elements. Will skip the missed_loop entirely if the participant has missed no trials in that block.
        timeline: [missed_loop],
        conditional_function: function() {
            if (missed.length > 0) { // Checks the length of the missed array. Will run the missed_loop only if the participant has missed any trials.
                return true;
            } else {
                return false;
            }
        }
    };


var perceptual = {
        type: 'canvas-keyboard-response',
        stimulus: gabor, // generates the two patches for the trial using the gabor function
        data: {condition: 'perceptual'}, // data stored for this trial
        choices: keys, response_ends_trial: false, trial_duration: duration,
        on_start: function(perceptual){
            document.body.style.cursor = "none";
            perceptual.index = index // index starts at 0
            if (s[jsPsych.currentTrial().index] === 0) { // state that the trial belongs to
                perceptual.action_s0 = action_s0
                perceptual.difference = randbet(high_min_neg, high_max_neg) // contrast differences for s = 0
                perceptual.reward = actionleft_100[jsPsych.currentTrial().action_s0] // picks the correct key press for this trial by serially sampling throug the list using action_s0
                perceptual.a = 0 // reward state i.e. of a = 0, then arrowleft is more profitable and it is vice versa, if a = 1
                action_s0 = action_s0 + 1; // increase the action_s0 by 1 to pick the next element from the action list for the next trial
            }
            else {
                perceptual.action_s1 = action_s1
                perceptual.difference = randbet(high_min, high_max)
                perceptual.reward = actionright_100[jsPsych.currentTrial().action_s1]
                perceptual.a = 1
                action_s1 = action_s1 + 1;
            }
            perceptual.contrast_left = avgcon + jsPsych.currentTrial().difference // calculate the contrast for the left gabor based on this trial's difference
            perceptual.contrast_right = avgcon - jsPsych.currentTrial().difference // calculate the contrast for the right gabor based on this trial's difference
        },
        on_finish: function (data) {
            data.block = 1 // 1 = perceptual, 2 = mixed, 3 = reward
            data.contrast = 0 // 0 = low contrast, 1 = high contrast
            if (data.response === jsPsych.currentTrial().reward) { // if the participant's key press is the same as the correct key_press
                data.correct = true;
                data.stim = 0; // keeps the stim value at 0 because the participant has not missed a trial
            } else if (data.response === null) { // if the participant does not respond to a particular trial
                missed.push(1),
                    missed_fb.push(jsPsych.currentTrial().reward),  // add this trial's correct response to the missed_fb array so that it can be repeated with the missed trial
                    missed_con.push(jsPsych.currentTrial().contrast_left), // add this trial's left contrast to the missed_con array so that it can be repeated with the missed trial
                    missed_con1.push(jsPsych.currentTrial().contrast_right) // add this trial's right contrast to the missed_con1 array so that it can be repeated with the missed trial
                missed_block.push(data.block)
                missed_contrast.push(data.contrast)
            } else { // if the participant's key_press is not the same as correct key_press
                data.correct = false;
                data.stim = 0; // keeps the stim value at 0 because the participant has not missed a trial
            }
            data.block = 1 // 1 = perceptual, 2 = mixed, 3 = reward
            data.corr_resp = jsPsych.currentTrial().reward // stores the correct response on this trial
            data.contrast_left = jsPsych.currentTrial().contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
            data.diff = jsPsych.currentTrial().difference
            trialcounter = trialcounter + 4 // increases the trial counter to include fixation, stimulus and feedback
            index = index + 1; // increase the index by 1 so that the next trial, the next state can be chosen from the state array
            data.state = s[jsPsych.currentTrial().index] // store the state of the trial
            data.reward = jsPsych.currentTrial().a // store the action for this trial
        }
    };
var perceptual_1 = {
        type: 'canvas-keyboard-response',
        stimulus: gabor, // generates the two patches for the trial using the gabor function
        data: {condition: 'perceptual'}, // data stored for this trial
        choices: keys, response_ends_trial: false, trial_duration: duration,
        on_start: function(perceptual_1){
            document.body.style.cursor = "none";
            perceptual_1.index = index // index starts at 0
            if (s[jsPsych.currentTrial().index] === 0) {
                perceptual_1.action_s0 = action_s0
                perceptual_1.difference = randbet(high_min_neg, high_max_neg)
                perceptual_1.reward = actionright_100[jsPsych.currentTrial().action_s0]
                perceptual_1.a = 1
                action_s0 = action_s0 + 1;
            }
            else {
                perceptual_1.action_s1 = action_s1
                perceptual_1.difference = randbet(high_min, high_max)
                perceptual_1.reward = actionleft_100[jsPsych.currentTrial().action_s1]
                perceptual_1.a = 0
                action_s1 = action_s1 + 1;
            }
            perceptual_1.contrast_left = avgcon + jsPsych.currentTrial().difference
            perceptual_1.contrast_right = avgcon - jsPsych.currentTrial().difference
            
        },
        on_finish: function (data) {
            data.block = 1
            if (data.response === jsPsych.currentTrial().reward) {
                data.correct = true;
                data.stim = 0;
            } else if (data.response === null) {
                missed.push(1),
                    missed_fb.push(jsPsych.currentTrial().reward),
                    missed_con.push(jsPsych.currentTrial().contrast_left),
                    missed_con1.push(jsPsych.currentTrial().contrast_right)
                    missed_block.push(data.block)
                    missed_contrast.push(data.contrast)
            } else {
                data.correct = false;
                data.stim = 0; // keeps the stim value at 0 because the participant has not missed a trial
            }
            data.contrast = 1 // 0 = low contrast, 1 = high contrast 
            data.corr_resp = jsPsych.currentTrial().reward // stores the correct response on this trial
            data.contrast_left = jsPsych.currentTrial().contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
            data.diff = jsPsych.currentTrial().difference
            trialcounter = trialcounter + 4 // increases the trial counter to include fixation, stimulus and feedback
            index = index + 1;
            data.state = s[jsPsych.currentTrial().index]
            data.reward = jsPsych.currentTrial().a
        }
    };
var reward = {
        type: 'canvas-keyboard-response',
        stimulus: gabor, // generates the two patches for the trial using the gabor function
        data: {condition: 'reward'}, // data stored for this trial
        choices: keys, response_ends_trial: false, trial_duration: duration,
        on_start: function(reward){
            document.body.style.cursor = "none";
            reward.index = index // index starts at 0
            if (s[jsPsych.currentTrial().index] === 0) {
                reward.action_s0 = action_s0
                reward.difference = randbet(low_min_neg, low_max_neg)
                reward.reward = actionleft_70[jsPsych.currentTrial().action_s0]
                reward.a = 0
                action_s0 = action_s0 + 1;
            }
            else {
                reward.action_s1 = action_s1
                reward.difference = randbet(low_min, low_max)
                reward.reward = actionright_70[jsPsych.currentTrial().action_s1]
                reward.a = 1
                action_s1 = action_s1 + 1;
            }
            reward.contrast_left = avgcon + jsPsych.currentTrial().difference
            reward.contrast_right = avgcon - jsPsych.currentTrial().difference
          
        },
        on_finish: function (data) {
            data.block = 3
            if (data.response === jsPsych.currentTrial().reward) {
                data.correct = true;
                data.stim = 0;
            } else if (data.response === null) {
                missed.push(1),
                    missed_fb.push(jsPsych.currentTrial().reward),
                    missed_con.push(jsPsych.currentTrial().contrast_left),
                    missed_con1.push(jsPsych.currentTrial().contrast_right)
                    missed_block.push(data.block)
                    missed_contrast.push(data.contrast)
            } else {
                data.correct = false;
                data.stim = 0; // keeps the stim value at 0 because the participant has not missed a trial
            }
            data.contrast = 0;
            data.corr_resp = jsPsych.currentTrial().reward // stores the correct response on this trial
            data.contrast_left = jsPsych.currentTrial().contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
            data.diff = jsPsych.currentTrial().difference
            trialcounter = trialcounter + 4 // increases the trial counter to include fixation, stimulus and feedback
            index = index + 1;
            data.state = s[jsPsych.currentTrial().index]
            data.reward = jsPsych.currentTrial().a
        }
    };
var reward_1 = {
        type: 'canvas-keyboard-response',
        stimulus: gabor, // generates the two patches for the trial using the gabor function
        data: {condition: 'reward'}, // data stored for this trial
        choices: keys, response_ends_trial: false, trial_duration: duration,
        on_start: function(reward_1){
            document.body.style.cursor = "none";
            reward_1.index = index // index starts at 0
            if (s[jsPsych.currentTrial().index] === 0) {
                reward_1.action_s0 = action_s0
                reward_1.difference = randbet(low_min_neg, low_max_neg)
                reward_1.reward = actionright_70[jsPsych.currentTrial().action_s0]
                reward_1.a = 1
                action_s0 = action_s0 + 1;
            }
            else {
                reward_1.action_s1 = action_s1
                reward_1.difference = randbet(low_min, low_max)
                reward_1.reward = actionleft_70[jsPsych.currentTrial().action_s1]
                reward_1.a = 0
                action_s1 = action_s1 + 1;
            }
            reward_1.contrast_left = avgcon + jsPsych.currentTrial().difference
            reward_1.contrast_right = avgcon - jsPsych.currentTrial().difference
            
        },
        on_finish: function (data) {
            data.block = 3
            if (data.response === jsPsych.currentTrial().reward) {
                data.correct = true;
                data.stim = 0;
            } else if (data.response === null) {
                missed.push(1),
                    missed_fb.push(jsPsych.currentTrial().reward),
                    missed_con.push(jsPsych.currentTrial().contrast_left),
                    missed_con1.push(jsPsych.currentTrial().contrast_right)
                    missed_block.push(data.block)
                    missed_contrast.push(data.contrast)
            } else {
                data.correct = false;
                data.stim = 0; // keeps the stim value at 0 because the participant has not missed a trial
            }
            data.contrast = 1;
            data.corr_resp = jsPsych.currentTrial().reward // stores the correct response on this trial
            data.contrast_left = jsPsych.currentTrial().contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
            data.diff = jsPsych.currentTrial().difference
            trialcounter = trialcounter + 4 // increases the trial counter to include fixation, stimulus and feedback
            index = index + 1;
            data.state = s[jsPsych.currentTrial().index]
            data.reward = jsPsych.currentTrial().a
        }
    };
var mixed = {
        type: 'canvas-keyboard-response',
        stimulus: gabor, // generates the two patches for the trial using the gabor function
        data: {condition: 'mixed'}, // data stored for this trial
        choices: keys, response_ends_trial: false, trial_duration: duration,
        on_start: function(mixed){
            document.body.style.cursor = "none";
            mixed.index = index // index starts at 0
            if (s[jsPsych.currentTrial().index] === 0) {
                mixed.action_s0 = action_s0
                mixed.difference = randbet(high_min_neg, high_max_neg)
                mixed.reward = actionleft_70[jsPsych.currentTrial().action_s0]
                mixed.a = 0
                action_s0 = action_s0 + 1;
            }
            else {
                mixed.action_s1 = action_s1
                mixed.difference = randbet(high_min, high_max)
                mixed.reward = actionright_70[jsPsych.currentTrial().action_s1]
                mixed.a = 1
                action_s1 = action_s1 + 1;
            }
            mixed.contrast_left = avgcon + jsPsych.currentTrial().difference
            mixed.contrast_right = avgcon - jsPsych.currentTrial().difference
            
        },
        on_finish: function (data) {
          data.block = 2
            if (data.response === jsPsych.currentTrial().reward) {
                data.correct = true;
                data.stim = 0;
            } else if (data.response === null) {
                missed.push(1),
                    missed_fb.push(jsPsych.currentTrial().reward),
                    missed_con.push(jsPsych.currentTrial().contrast_left),
                    missed_con1.push(jsPsych.currentTrial().contrast_right)
                    missed_block.push(data.block)
                    missed_contrast.push(data.contrast)
            } else {
                data.correct = false;
                data.stim = 0; // keeps the stim value at 0 because the participant has not missed a trial
            }
            data.contrast = 0;
            data.corr_resp = jsPsych.currentTrial().reward // stores the correct response on this trial
            data.contrast_left = jsPsych.currentTrial().contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
            data.diff = jsPsych.currentTrial().difference
            trialcounter = trialcounter + 4 // increases the trial counter to include fixation, stimulus and feedback
            index = index + 1;
            data.state = s[jsPsych.currentTrial().index]
            data.reward = jsPsych.currentTrial().a
        }
    };
var mixed_1 = {
        type: 'canvas-keyboard-response',
        stimulus: gabor, // generates the two patches for the trial using the gabor function
        data: {condition: 'mixed'}, // data stored for this trial
        choices: keys, response_ends_trial: false, trial_duration: duration,
        on_start: function(mixed_1){
            document.body.style.cursor = "none";
            mixed_1.index = index // index starts at 0
            if (s[jsPsych.currentTrial().index] === 0) {
                mixed_1.action_s0 = action_s0
                mixed_1.difference = randbet(high_min_neg, high_max_neg)
                mixed_1.reward = actionright_70[jsPsych.currentTrial().action_s0]
                mixed_1.a = 1
                action_s0 = action_s0 + 1;
            }
            else {
                mixed_1.action_s1 = action_s1
                mixed_1.difference = randbet(high_min, high_max)
                mixed_1.reward = actionleft_70[jsPsych.currentTrial().action_s1]
                mixed_1.a = 0
                action_s1 = action_s1 + 1;
            }
            mixed_1.contrast_left = avgcon + jsPsych.currentTrial().difference
            mixed_1.contrast_right = avgcon - jsPsych.currentTrial().difference
            
        },
        on_finish: function (data) {
          data.block = 2
            if (data.response === jsPsych.currentTrial().reward) {
                data.correct = true;
                data.stim = 0;
            } else if (data.response === null) {
                missed.push(1),
                    missed_fb.push(jsPsych.currentTrial().reward),
                    missed_con.push(jsPsych.currentTrial().contrast_left),
                    missed_con1.push(jsPsych.currentTrial().contrast_right)
                    missed_block.push(data.block)
                    missed_contrast.push(data.contrast)
            } else {
                data.correct = false;
                data.stim = 0; // keeps the stim value at 0 because the participant has not missed a trial
            }
            data.contrast = 1
            data.corr_resp = jsPsych.currentTrial().reward // stores the correct response on this trial
            data.contrast_left = jsPsych.currentTrial().contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
            data.diff = jsPsych.currentTrial().difference
            trialcounter = trialcounter + 4 // increases the trial counter to include fixation, stimulus and feedback
            index = index + 1;
            data.state = s[jsPsych.currentTrial().index]
            data.reward = jsPsych.currentTrial().a
        }
    };
    
var mu = {
      type: 'canvas-slider-response',
      canvas_size: [300, 500],
      button_label: 'Next trial',
      data: {condition: 'mu'},
      stimulus: gabor,
      //require_movement: true,
      response_ends_trial: true,
      trial_duration: 6000,
      //slider_start: 0,
      labels: ['0%','25%', '50%', '75%', '100%'],
      on_start: function(mu) {
            document.body.style.cursor = "auto";
            mu.contrast_left = avgcon + jsPsych.data.get().last(1).values()[0].difference // calculate the contrast for the left gabor based on this trial's difference
            mu.contrast_right  = avgcon - jsPsych.data.get().last(1).values()[0].difference
      },
      on_load: function(){
	document.querySelector('#jspsych-canvas-slider-response-response').addEventListener('click', function(e){
		e.target.style.visibility = 'show'
	})
	},
      prompt: function () {
        var con_left = avgcon + jsPsych.data.get().last(1).values()[0].difference
        var con_right =  avgcon - jsPsych.data.get().last(1).values()[0].difference
        var trial_contrast = jsPsych.data.get().last(2).values()[0].contrast
        if (trial_contrast === 0) {
          if (con_left > con_right) {
              return " <p> If you choose the image on your right, what do you think is the chance of winning a reward? </p>"
            }
            else {
              return " <p> If you choose the image on your left, what do you think is the chance of winning a reward? </p>"
            }
        }
        else {
          if (con_left > con_right) {
              return " <p> If you choose the image on your left, what do you think is the chance of winning a reward? </p>"
            }
            else {
              return " <p> If you choose the image on your right, what do you think is the chance of winning a reward? </p>"
          }
        }
        },
      on_finish: function (data) {
            data.contrast_left = jsPsych.data.get().last(1).values()[0].contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.data.get().last(1).values()[0].contrast_right // stores the contrast level of right patch on this trial
            data.diff = jsPsych.data.get().last(1).values()[0].difference
            index_mu = index_mu + 1;
            data.state = s[jsPsych.currentTrial().index_mu]
        }
    };
var mu_1 = {
      type: 'canvas-slider-response',
      canvas_size: [300, 500],
      button_label: 'Next trial',
      stimulus: gabor,
      data: {condition: 'mu'},
      response_ends_trial: true,
      //require_movement: true,
      //slider_start: 0,
      trial_duration: 6000,
      labels: ['0%','25%', '50%', '75%', '100%'],
      on_start: function(mu_1) {
            document.body.style.cursor = "auto";
            mu_1.contrast_left = avgcon + jsPsych.data.get().last(1).values()[0].difference // calculate the contrast for the left gabor based on this trial's difference
            mu_1.contrast_right  = avgcon - jsPsych.data.get().last(1).values()[0].difference
      },
      on_load: function(){
	      document.querySelector('#jspsych-canvas-slider-response-response').addEventListener('click', function(e){
		    e.target.style.visibility = 'show'})},
      prompt: function () {
        var con_left = avgcon + jsPsych.data.get().last(1).values()[0].difference
        var con_right =  avgcon - jsPsych.data.get().last(1).values()[0].difference
        var trial_contrast = jsPsych.data.get().last(2).values()[0].contrast
        if (trial_contrast === 0) {
          if (con_left > con_right) {
              return " <p> If you choose the image on your left, what do you think is the chance of winning a reward? </p>"
            }
            else {
              return " <p> If you choose the image on your right, what do you think is the chance of winning a reward? </p>"
            }
        }
        else {
          if (con_left > con_right) {
              return " <p> If you choose the image on your right, what do you think is the chance of winning a reward? </p>"
            }
            else {
              return " <p> If you choose the image on your left, what do you think is the chance of winning a reward? </p>"
          }
        }
        },
      on_finish: function (data) {
            data.contrast_left = jsPsych.data.get().last(1).values()[0].contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.data.get().last(1).values()[0].contrast_right // stores the contrast level of right patch on this trial
            data.diff = jsPsych.data.get().last(1).values()[0].difference
            index_mu = index_mu + 1;
            data.state = s[jsPsych.currentTrial().index_mu]
        }
    };
var trial_perceptual = {timeline: [fix, perceptual, fb, mu], repetitions: 25, randomize_order: false};
var trial_perceptual_1 = {timeline: [fix, perceptual_1, fb, mu], repetitions: 25, randomize_order: false};
var trial_reward = {timeline: [fix, reward, fb, mu], repetitions: 25, randomize_order: false};
var trial_reward_1 = {timeline: [fix, reward_1, fb, mu], repetitions: 25, randomize_order: false};
var trial_mixed = {timeline: [fix, mixed, fb, mu], repetitions: 25, randomize_order: false};
var trial_mixed_1 = {timeline: [fix, mixed_1, fb, mu], repetitions: 25, randomize_order: false};
    
var trial_perceptual_mu_1 = {timeline: [fix, perceptual, fb, mu_1], repetitions: 25, randomize_order: false};
var trial_perceptual_1_mu_1 = {timeline: [fix, perceptual_1, fb, mu_1], repetitions: 25, randomize_order: false};
var trial_reward_mu_1 = {timeline: [fix, reward, fb, mu_1], repetitions: 25, randomize_order: false};
var trial_reward_1_mu_1 = {timeline: [fix, reward_1, fb, mu_1], repetitions: 25, randomize_order: false};
var trial_mixed_mu_1 = {timeline: [fix, mixed, fb, mu_1], repetitions: 25, randomize_order: false};
var trial_mixed_1_mu_1 = {timeline: [fix, mixed_1, fb, mu_1], repetitions: 25, randomize_order: false};

var block1 = {timeline: [trial_perceptual, missed_conditional, score], repetitions: 1};
var block2 = {timeline: [trial_perceptual_1, missed_conditional, score], repetitions: 1};
var block3 = {timeline: [trial_reward, missed_conditional, score], repetitions: 1};
var block4 = {timeline: [trial_reward_1, missed_conditional, score], repetitions: 1};
var block5 = {timeline: [trial_mixed, missed_conditional, score], repetitions: 1};
var block6 = {timeline: [trial_mixed_1, missed_conditional, score], repetitions: 1};
    
var block7 = {timeline: [trial_perceptual_mu_1, missed_conditional, score], repetitions: 1};
var block8 = {timeline: [trial_perceptual_1_mu_1, missed_conditional, score], repetitions: 1};
var block9 = {timeline: [trial_reward_mu_1, missed_conditional, score], repetitions: 1};
var block10 = {timeline: [trial_reward_1_mu_1, missed_conditional, score], repetitions: 1};
var block11 = {timeline: [trial_mixed_mu_1, missed_conditional, score], repetitions: 1};
var block12 = {timeline: [trial_mixed_1_mu_1, missed_conditional, score], repetitions: 1};

var start = {timeline: [welcome, survey_id]};
var blockarray = [block1, block7, block6, block5, block4, block3, block2, block8, block9, block10, block11, block12];
var blocks_shuffled = jsPsych.randomization.shuffle(blockarray); // first set of blocks
var block_1 = blocks_shuffled[0]; var block_2 = blocks_shuffled[1]; var block_3 = blocks_shuffled[2]; var block_4 = blocks_shuffled[3]; 
var block_5 = blocks_shuffled[4]; var block_6 = blocks_shuffled[5]; var block_7 = blocks_shuffled[6]; var block_8 = blocks_shuffled[7];
var block_9 = blocks_shuffled[8]; var block_10 = blocks_shuffled[9]; var block_11 = blocks_shuffled[10]; var block_12 = blocks_shuffled[11];
var blocks_shuffled_array = [block_1, nextblock, block_2, nextblock, block_3, nextblock, block_4, nextblock, block_5, nextblock, block_6, nextblock, block_7, nextblock, block_8, nextblock, block_9, nextblock, block_10, nextblock, block_11, nextblock]
var blocks = {timeline: [blocks_shuffled_array], repetitions:1}

timeline.push(start)
timeline.push(block_1); timeline.push(nextblock); timeline.push(block_2); timeline.push(nextblock); timeline.push(block_3); timeline.push(nextblock);
timeline.push(block_4); timeline.push(nextblock); timeline.push(block_5); timeline.push(nextblock); timeline.push(block_6); timeline.push(nextblock);
timeline.push(block_7); timeline.push(nextblock); timeline.push(block_8); timeline.push(nextblock); timeline.push(block_9); timeline.push(nextblock);
timeline.push(block_10); timeline.push(nextblock); timeline.push(block_11); timeline.push(nextblock); timeline.push(block_12); timeline.push(nextblock);
timeline.push(completion_id)
jsPsych.init({
        timeline: timeline,
    });
</script> 
