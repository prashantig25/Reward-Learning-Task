<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Experiment</title>
    <script src="js/jspsych.js"></script>
    <script src="js/additionals.js"></script>
    <script src="js/custom.css"></script>
    <script src="js/jspsych-canvas-slider-response.js"></script>
    <script src="js/jspsych-survey-text.js"></script>
    <script src="js/jspsych-html-keyboard-response.js"></script>
    <script src="js/jspsych-canvas-keyboard-multiple-response.js"></script>
    <script src="js/jspsych-canvas-keyboard-response.js"></script>
    <link href="js/jspsych.css" rel="stylesheet" type="text/css"/>
</head>
<style>
    body {
        background-color: #808080;
    }
</style>
<script>
var timeline = [];
var enter_trial = {
    type: "html-keyboard-response",
    stimulus: "<p style=\"font-size: 20px;color: #000000; position: relative; top: 20px; left: 5px;\"> Please press the <strong> ENTER </strong> key to proceed. </p>",
    choices: ['Enter'],
    trial_duration: 2000,
};
var fix = { // fixation cross
        type: 'canvas-keyboard-response',
        stimulus: fixation,
        trial_duration: fix_dura,
        choices: jsPsych.NO_KEYS,
        data: { condition: 'fixation'},
        on_start: function () { // hide cursor from the screen
          document.body.style.cursor = "none";
        }
    };
var welcome = { // introductory text for participants
        type: "html-keyboard-response",
        stimulus: "<p style=\"font-size: 20px;color: #000000\"> Welcome to the study. </p> <p> Please make sure that you are participating in this study in a calm and comfortable environment. Please place your desktop screen at one-arm distance from your eyes. <br> There are instructions at every stage of the study. Please read and understand them carefully. <br> If you are running this study on Safari, please exit now and restart the study on any other browser (e.g. Chrome, Firefox, MS Edge). </p> <p> Press any key to process forward.</p>",
    };
var survey_id = {
        type: 'survey-text',
        questions:[
            {prompt: "Please enter your correct unique Prolific ID here.", name: 'Prolific_ID'}],
        button_label:'Next',
    };

var score = { //indicates total score at the end of a block of trials
        type: 'html-keyboard-response',
        on_start: function(score){ //at the start of the trial.
            score.total = jsPsych.data.get().last(trialcounter).select('correct').sum() // returns the total score in a block.
        },
        stimulus:function () { 
            var points = jsPsych.data.get().last(trialcounter).select('correct').sum() // adds all the points earned in the last n (trialcounter) number of trials to present total points at the end of the block.
            return `<p style=\"font-size: 25px;color: #000000\">You win <strong> ${points} </strong> points in this block. <br> You have completed <strong> ${counter} </strong> blocks out of 12 blocks of the experiment. Press a key to proceed forward.</p>`
        },
        on_finish: function(data) { // function after the trial ends.
            data.finalscore = jsPsych.currentTrial().total // final score after each block
            trialcounter = 0 // trial counter resets to 0 after a block ends because the trialcounter counts the number of points in each block seperately
            index = 0 // index of rewards also resets to 0 after a block ends
            index_missed = 0
            index_mu = 0
            action_s0 = 0; // index of state = 0 also resets to 0 after a block ends
            action_s1 = 0; // index of state = 1 also resets to 0 after a block ends
            counter = counter + 1; // Increase the counter by one when a fresh block of trials start.
            s = shuffle(state); // array of a trial's state is shuffled for next block.
            s_mu = shuffle(state_mu); // array of a slider's state is shuffled for next block.
        }
    };   
var fb = { // feedback for choice
        type: "html-keyboard-response", choices: jsPsych.NO_KEYS, trial_duration: duration, data: {condition: 'feedback'},
        stimulus: function () {
            var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
            if (last_trial_correct) {
                return "<p style=\"font-size: 30px;color: #016901; position: relative; top: 20px; left: -5px;\">You win 1 point!</p>";
            } else {
                return "<p style=\"font-size: 30px;color: #ba0000; position: relative; top: 20px; left: -5px;\">You win 0 points!</p>"
            }
        },
        on_finish: function(data) {
          data.index = index_mu // index starts at 0
          var blocktype = jsPsych.data.get().last(2).values()[0].block // blocktype is dependent on condition i.e. 1 = perceptual; 2 = mixed and 3 = reward
          if ( blocktype === 1 || blocktype === 2) { 
            if (s_mu[data.index] === 0) { // state that the slider belongs to
                data.difference = -0.15 // contrast differences for s = 0
            }
            else {
                data.difference = 0.15 // contrast differences for s = 1
            }
          }
          else {
              if (s_mu[data.index] === 0) { // state that the slider belongs to
                data.difference = -0.45 // contrast differences for s = 0
              }
              else {
                data.difference = 0.45 // contrast differences for s = 0
              }
            }
          
          data.contrast_left = avgcon + data.difference // calculate the contrast for the left gabor based on this trial's difference
          data.contrast_right  = avgcon - data.difference
        }
    };
var firstblock = {
        type: "html-keyboard-response",
        stimulus: "<p style=\"font-size: 20px;color: #000000\"> The first block of trials will begin now. <br> The relationship between the contrast level of the images and reward may change now as compared to previous blocks. <br> Press a key when you are ready.</p>",
    };
var nextblock = {
        type: "html-keyboard-response",
        stimulus: "<p style=\"font-size: 20px;color: #000000\"> Next block begins now. <br> The relationship between the contrast level of the images and reward may change now as compared to previous blocks. <br> Press a key when you are ready.</p>",
    };
var completion_id = {
        type: 'survey-text',
        questions: [
            {prompt: "The completion code for this study is 8B6FC8DB. Enter this code here.", name: 'Completion_code'}],
    };

var perceptual = { // choice phase with patches belonging to the perceptual condition with low contrast patch winning more often.
        type: 'canvas-keyboard-multiple-response',
        stimulus: gabor, // generates the two patches for the trial using the gabor function
        data: {condition: 'perceptual_lc'}, // data stored for this trial
        choices: keys, response_ends_trial: false, trial_duration: duration,
        on_start: function(perceptual){ // value for required variables calculated before the trial starts.
            document.body.style.cursor = "none"; // to hide the cursor when the patches are presented
            perceptual.index = index // index starts at 0
            if (s[jsPsych.currentTrial().index] === 0) { // state that the trial belongs to
                perceptual.action_s0 = action_s0 // index to choose correct response from reward array
                perceptual.difference = randbet(high_min_neg, high_max_neg) // contrast differences for s = 0
                perceptual.reward = actionleft_100[jsPsych.currentTrial().action_s0] // picks the correct key press for this trial by serially sampling throug the list using action_s0
                perceptual.a = 0 // reward state i.e. of a = 0, then arrowleft is more profitable and it is vice versa, if a = 1
                action_s0 = action_s0 + 1; // increase the action_s0 by 1 to pick the next element from the action list for the next trial
            }
            else { 
                perceptual.action_s1 = action_s1
                perceptual.difference = randbet(high_min, high_max)
                perceptual.reward = actionright_100[jsPsych.currentTrial().action_s1]
                perceptual.a = 1
                action_s1 = action_s1 + 1;
            }
            perceptual.contrast_left = avgcon + jsPsych.currentTrial().difference // calculate the contrast for the left gabor based on this trial's difference
            perceptual.contrast_right = avgcon - jsPsych.currentTrial().difference // calculate the contrast for the right gabor based on this trial's difference
            perceptual.block = 1; // 1 = perceptual, 2 = mixed, 3 = reward
            perceptual.contrast = 0; // 0 = low contrast, 1 = high contrast
        },
        on_finish: function (data) { // data stored after the trial is finished
            var response = data.response // responses for a trial
            var length = response.length // calculates the length of the response array
            if (data.response[length-1] === jsPsych.currentTrial().reward) { // if the participant's latest key press is the same as the correct key_press
                data.correct = true;
                data.stim = 0; // keeps the stim value at 0 because the participant has not missed a trial
            } else if (length === 0) { // if the participant does not respond to a particular trial
                    missed.push(1) // increases a missed trial by 1
                    missed_fb.push(jsPsych.currentTrial().reward)  // add this trial's correct response to the missed_fb array so that it can be repeated with the missed trial
                    missed_con.push(jsPsych.currentTrial().contrast_left) // add this trial's left contrast to the missed_con array so that it can be repeated with the missed trial
                    missed_con1.push(jsPsych.currentTrial().contrast_right) // add this trial's right contrast to the missed_con1 array so that it can be repeated with the missed trial
                    missed_block.push(jsPsych.currentTrial().block) // add this trial's block type to the missed_block array
                    missed_contrast.push(jsPsych.currentTrial().contrast) // add this trial's winning contrast to the missed_block array
            } else { // if the participant's key_press is not the same as correct key_press
                data.correct = false;
                data.stim = 0; // keeps the stim value at 0 because the participant has not missed a trial
            }
            data.block = jsPsych.currentTrial().block // 1 = perceptual, 2 = mixed, 3 = reward
            data.contrast = jsPsych.currentTrial().contrast // 0 = low contrast; 1 = high contrast
            data.corr_resp = jsPsych.currentTrial().reward // stores the correct response on this trial
            data.contrast_left = jsPsych.currentTrial().contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
            data.diff = jsPsych.currentTrial().difference // stores the difference
            trialcounter = trialcounter + 6 // increases the trial counter to include fixation, choice, feedback, slider_wait, slider_response and enter_keypress
            index = index + 1; // increase the index by 1 so that the next trial, the next state can be chosen from the state array
            data.state = s[jsPsych.currentTrial().index] // store the state of the trial
            data.reward = jsPsych.currentTrial().a // store the action for this trial
        }
    };
var perceptual_1 = { // choice phase with patches belonging to the perceptual condition with high contrast patch winning more often.
        type: 'canvas-keyboard-multiple-response',
        stimulus: gabor, // generates the two patches for the trial using the gabor function
        data: {condition: 'perceptual_hc'}, // data stored for this trial
        choices: keys, response_ends_trial: false, trial_duration: duration,
        on_start: function(perceptual_1){
            document.body.style.cursor = "none";
            perceptual_1.index = index // index starts at 0
            if (s[jsPsych.currentTrial().index] === 0) {
                perceptual_1.action_s0 = action_s0
                perceptual_1.difference = randbet(high_min_neg, high_max_neg)
                perceptual_1.reward = actionright_100[jsPsych.currentTrial().action_s0]
                perceptual_1.a = 1
                action_s0 = action_s0 + 1;
            }
            else {
                perceptual_1.action_s1 = action_s1
                perceptual_1.difference = randbet(high_min, high_max)
                perceptual_1.reward = actionleft_100[jsPsych.currentTrial().action_s1]
                perceptual_1.a = 0
                action_s1 = action_s1 + 1;
            }
            perceptual_1.contrast_left = avgcon + jsPsych.currentTrial().difference
            perceptual_1.contrast_right = avgcon - jsPsych.currentTrial().difference
            perceptual_1.block = 1;
            perceptual_1.contrast = 1;
        },
        on_finish: function (data) {
            var response = data.response
            var length = response.length
            if (data.response[length-1] === jsPsych.currentTrial().reward) {
                data.correct = true;
                data.stim = 0;
            } else if (length === 0) {
                missed.push(1)
                    missed_fb.push(jsPsych.currentTrial().reward)
                    missed_con.push(jsPsych.currentTrial().contrast_left)
                    missed_con1.push(jsPsych.currentTrial().contrast_right)
                    missed_block.push(jsPsych.currentTrial().block)
                    missed_contrast.push(jsPsych.currentTrial().contrast)
            } else {
                data.correct = false;
                data.stim = 0; // keeps the stim value at 0 because the participant has not missed a trial
            }
            data.block = jsPsych.currentTrial().block;
            data.contrast = jsPsych.currentTrial().contrast;
            data.corr_resp = jsPsych.currentTrial().reward // stores the correct response on this trial
            data.contrast_left = jsPsych.currentTrial().contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
            data.diff = jsPsych.currentTrial().difference
            trialcounter = trialcounter + 6 // increases the trial counter to include fixation, stimulus and feedback
            index = index + 1;
            data.state = s[jsPsych.currentTrial().index]
            data.reward = jsPsych.currentTrial().a
        }
    };
var reward = { // choice phase with patches belonging to the reward condition with low contrast patch winning more often.
        type: 'canvas-keyboard-multiple-response',
        stimulus: gabor, // generates the two patches for the trial using the gabor function
        data: {condition: 'reward_lc'}, // data stored for this trial
        choices: keys, response_ends_trial: false, trial_duration: duration,
        on_start: function(reward){
            document.body.style.cursor = "none";
            reward.index = index // index starts at 0
            if (s[jsPsych.currentTrial().index] === 0) {
                reward.action_s0 = action_s0
                reward.difference = randbet(low_min_neg, low_max_neg)
                reward.reward = actionleft_70[jsPsych.currentTrial().action_s0]
                reward.a = 0
                action_s0 = action_s0 + 1;
            }
            else {
                reward.action_s1 = action_s1
                reward.difference = randbet(low_min, low_max)
                reward.reward = actionright_70[jsPsych.currentTrial().action_s1]
                reward.a = 1
                action_s1 = action_s1 + 1;
            }
            reward.contrast_left = avgcon + jsPsych.currentTrial().difference
            reward.contrast_right = avgcon - jsPsych.currentTrial().difference
            reward.block = 3
            reward.contrast = 0
        },
        on_finish: function (data) {
            var response = data.response
            var length = response.length
            if (data.response[length-1] === jsPsych.currentTrial().reward) {
                data.correct = true;
                data.stim = 0;
            } else if (length === 0) {
                missed.push(1)
                    missed_fb.push(jsPsych.currentTrial().reward)
                    missed_con.push(jsPsych.currentTrial().contrast_left)
                    missed_con1.push(jsPsych.currentTrial().contrast_right)
                    missed_block.push(jsPsych.currentTrial().block)
                    missed_contrast.push(jsPsych.currentTrial().contrast)
            } else {
                data.correct = false;
                data.stim = 0; // keeps the stim value at 0 because the participant has not missed a trial
            }
            data.contrast = jsPsych.currentTrial().contrast;
            data.block = jsPsych.currentTrial().block;
            data.corr_resp = jsPsych.currentTrial().reward // stores the correct response on this trial
            data.contrast_left = jsPsych.currentTrial().contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
            data.diff = jsPsych.currentTrial().difference
            trialcounter = trialcounter + 6 // increases the trial counter to include fixation, stimulus and feedback
            index = index + 1;
            data.state = s[jsPsych.currentTrial().index]
            data.reward = jsPsych.currentTrial().a
        }
    };
var reward_1 = { // choice phase with patches belonging to the reward condition with high contrast patch winning more often.
        type: 'canvas-keyboard-multiple-response',
        stimulus: gabor, // generates the two patches for the trial using the gabor function
        data: {condition: 'reward_hc'}, // data stored for this trial
        choices: keys, response_ends_trial: false, trial_duration: duration,
        on_start: function(reward_1){
            document.body.style.cursor = "none";
            reward_1.index = index // index starts at 0
            if (s[jsPsych.currentTrial().index] === 0) {
                reward_1.action_s0 = action_s0
                reward_1.difference = randbet(low_min_neg, low_max_neg)
                reward_1.reward = actionright_70[jsPsych.currentTrial().action_s0]
                reward_1.a = 1
                action_s0 = action_s0 + 1;
            }
            else {
                reward_1.action_s1 = action_s1
                reward_1.difference = randbet(low_min, low_max)
                reward_1.reward = actionleft_70[jsPsych.currentTrial().action_s1]
                reward_1.a = 0
                action_s1 = action_s1 + 1;
            }
            reward_1.contrast_left = avgcon + jsPsych.currentTrial().difference
            reward_1.contrast_right = avgcon - jsPsych.currentTrial().difference
            reward_1.block = 3;
            reward_1.contrast = 1;
        },
        on_finish: function (data) {
            var response = data.response
            var length = response.length
            if (data.response[length-1] === jsPsych.currentTrial().reward) {
                data.correct = true;
                data.stim = 0;
            } else if (length === 0) {
                missed.push(1)
                    missed_fb.push(jsPsych.currentTrial().reward)
                    missed_con.push(jsPsych.currentTrial().contrast_left)
                    missed_con1.push(jsPsych.currentTrial().contrast_right)
                    missed_block.push(jsPsych.currentTrial().block)
                    missed_contrast.push(jsPsych.currentTrial().contrast)
            } else {
                data.correct = false;
                data.stim = 0; // keeps the stim value at 0 because the participant has not missed a trial
            }
            data.contrast = jsPsych.currentTrial().contrast;
            data.block = jsPsych.currentTrial().block;
            data.corr_resp = jsPsych.currentTrial().reward // stores the correct response on this trial
            data.contrast_left = jsPsych.currentTrial().contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
            data.diff = jsPsych.currentTrial().difference
            trialcounter = trialcounter + 6 // increases the trial counter to include fixation, stimulus and feedback
            index = index + 1;
            data.state = s[jsPsych.currentTrial().index]
            data.reward = jsPsych.currentTrial().a
        }
    };
var mixed = { // choice phase with patches belonging to the mixed condition with low contrast patch winning more often.
        type: 'canvas-keyboard-multiple-response',
        stimulus: gabor, // generates the two patches for the trial using the gabor function
        data: {condition: 'mixed_lc'}, // data stored for this trial
        choices: keys, response_ends_trial: false, trial_duration: duration,
        on_start: function(mixed){
            document.body.style.cursor = "none";
            mixed.index = index // index starts at 0
            if (s[jsPsych.currentTrial().index] === 0) {
                mixed.action_s0 = action_s0
                mixed.difference = randbet(high_min_neg, high_max_neg)
                mixed.reward = actionleft_70[jsPsych.currentTrial().action_s0]
                mixed.a = 0
                action_s0 = action_s0 + 1;
            }
            else {
                mixed.action_s1 = action_s1
                mixed.difference = randbet(high_min, high_max)
                mixed.reward = actionright_70[jsPsych.currentTrial().action_s1]
                mixed.a = 1
                action_s1 = action_s1 + 1;
            }
            mixed.contrast_left = avgcon + jsPsych.currentTrial().difference
            mixed.contrast_right = avgcon - jsPsych.currentTrial().difference
            mixed.block = 2;
            mixed.contrast = 0;
        },
        on_finish: function (data) {
            var response = data.response
            var length = response.length
            if (data.response[length-1] === jsPsych.currentTrial().reward) {
                data.correct = true;
                data.stim = 0;
            } else if (length === 0) {
                missed.push(1)
                    missed_fb.push(jsPsych.currentTrial().reward)
                    missed_con.push(jsPsych.currentTrial().contrast_left)
                    missed_con1.push(jsPsych.currentTrial().contrast_right)
                    missed_block.push(jsPsych.currentTrial().block)
                    missed_contrast.push(jsPsych.currentTrial().contrast)
            } else {
                data.correct = false;
                data.stim = 0; // keeps the stim value at 0 because the participant has not missed a trial
            }
            data.block = jsPsych.currentTrial().block;
            data.contrast = jsPsych.currentTrial().contrast;
            data.corr_resp = jsPsych.currentTrial().reward // stores the correct response on this trial
            data.contrast_left = jsPsych.currentTrial().contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
            data.diff = jsPsych.currentTrial().difference
            trialcounter = trialcounter + 6 // increases the trial counter to include fixation, stimulus and feedback
            index = index + 1;
            data.state = s[jsPsych.currentTrial().index]
            data.reward = jsPsych.currentTrial().a
        }
    };
var mixed_1 = { // choice phase with patches belonging to the mixed condition with high contrast patch winning more often.
        type: 'canvas-keyboard-multiple-response',
        stimulus: gabor, // generates the two patches for the trial using the gabor function
        data: {condition: 'mixed_hc'}, // data stored for this trial
        choices: keys, response_ends_trial: false, trial_duration: duration,
        on_start: function(mixed_1){
            document.body.style.cursor = "none";
            mixed_1.index = index // index starts at 0
            if (s[jsPsych.currentTrial().index] === 0) {
                mixed_1.action_s0 = action_s0
                mixed_1.difference = randbet(high_min_neg, high_max_neg)
                mixed_1.reward = actionright_70[jsPsych.currentTrial().action_s0]
                mixed_1.a = 1
                action_s0 = action_s0 + 1;
            }
            else {
                mixed_1.action_s1 = action_s1
                mixed_1.difference = randbet(high_min, high_max)
                mixed_1.reward = actionleft_70[jsPsych.currentTrial().action_s1]
                mixed_1.a = 0
                action_s1 = action_s1 + 1;
            }
            mixed_1.contrast_left = avgcon + jsPsych.currentTrial().difference
            mixed_1.contrast_right = avgcon - jsPsych.currentTrial().difference
            mixed_1.block = 2;
            mixed_1.contrast = 1;
        },
        on_finish: function (data) {
            var response = data.response
            var length = response.length
            if (data.response[length-1] === jsPsych.currentTrial().reward) {
                data.correct = true;
                data.stim = 0;
            } else if (length === 0) {
                missed.push(1)
                    missed_fb.push(jsPsych.currentTrial().reward)
                    missed_con.push(jsPsych.currentTrial().contrast_left)
                    missed_con1.push(jsPsych.currentTrial().contrast_right)
                    missed_block.push(jsPsych.currentTrial().block)
                    missed_contrast.push(jsPsych.currentTrial().contrast)
            } else {
                data.correct = false;
                data.stim = 0; // keeps the stim value at 0 because the participant has not missed a trial
            }
            data.contrast = jsPsych.currentTrial().contrast
            data.block = jsPsych.currentTrial().block
            data.corr_resp = jsPsych.currentTrial().reward // stores the correct response on this trial
            data.contrast_left = jsPsych.currentTrial().contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
            data.diff = jsPsych.currentTrial().difference
            trialcounter = trialcounter + 6 // increases the trial counter to include fixation, stimulus and feedback
            index = index + 1;
            data.state = s[jsPsych.currentTrial().index]
            data.reward = jsPsych.currentTrial().a
        }
    };
var mu = { // part of the trial with the slider; congruent slider trial i.e. the most rewarded patch in the trial phase is used for mu estimates
      type: 'canvas-slider-response', // plugin required to present participants with slider
      canvas_size: [300, 500], // size of the canvas
      data: {condition: 'mu_congruent'}, 
      stimulus: gabor_mu, // canvas object
      response_ends_trial: true, // trial ends as soon as participant responds
      require_movement: false, 
      trial_duration: 6000,
      labels: ['0%','25%', '50%', '75%', '100%'], // labels on the slider
      on_start: function(mu) { // variables required for the trial; calculated at the start of the trial.
            document.body.style.cursor = "auto"; // to hide the cursor
            var trial_contrast = jsPsych.data.get().last(3).values()[0].contrast // contrast of the patch that is going to be used for mu estimates
            mu.contrast_left = avgcon + jsPsych.data.get().last(2).values()[0].difference // calculate the contrast for the left gabor based on this trial's difference
            mu.contrast_right  = avgcon - jsPsych.data.get().last(2).values()[0].difference
            if (trial_contrast === 0) { // calculate the position of the border to indicate the patch for mu estimate
                if (jsPsych.currentTrial().contrast_left > jsPsych.currentTrial().contrast_right) {
                  mu.x = 305; //right patch
                }
                else {
                  mu.x = 100; //left patch
                }
            }
            else {
                if (jsPsych.currentTrial().contrast_left > jsPsych.currentTrial().contrast_right) {
                  mu.x = 100; // left patch
                }
                else {
                  mu.x = 305; //right patch
               }
            }
      },
      prompt: function () { // generates the prompt for the slider depending on the patch that is used for mu estimates
        var con_left = avgcon + jsPsych.data.get().last(2).values()[0].difference
        var con_right =  avgcon - jsPsych.data.get().last(2).values()[0].difference
        var trial_contrast = jsPsych.data.get().last(3).values()[0].contrast
        if (trial_contrast === 0) {
          if (con_left > con_right) {
              return `<p> If you choose the image on your <strong> right</strong>, what do you think is the chance of winning a reward? </p>  `
            }
            else {
              return `<p> If you choose the image on your <strong> left</strong>, what do you think is the chance of winning a reward? </p>  `
            }
        }
        else {
          if (con_left > con_right) {
              return `<p> If you choose the image on your <strong> left</strong>, what do you think is the chance of winning a reward? </p>  `
            }
            else {
              return `<p> If you choose the image on your <strong> right</strong>, what do you think is the chance of winning a reward? </p>  `
          }
        }
        }, 
      on_finish: function (data) { // data stored after the trial is finished
            data.contrast_left = jsPsych.currentTrial().contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
            index_mu = index_mu + 1; // increase the index_mu for the next trial. 
            data.state = s[index_mu] // state that the patches in the slider phase belonged to
        }
    };
var mu_1 = { // same as mu except incongruent slider trial i.e. the less rewarded patch in the trial phase is used for mu estimates
      type: 'canvas-slider-response',
      canvas_size: [300, 500],
      data: {condition: 'mu_incongruent'},
      stimulus: gabor_mu,
      response_ends_trial: true,
      require_movement: false,
      trial_duration: 6000,
      labels: ['0%','25%', '50%', '75%', '100%'],
      on_start: function(mu_1) {
            document.body.style.cursor = "auto";
            var trial_contrast = jsPsych.data.get().last(3).values()[0].contrast
            mu_1.contrast_left = avgcon + jsPsych.data.get().last(2).values()[0].difference // calculate the contrast for the left gabor based on this trial's difference
            mu_1.contrast_right  = avgcon - jsPsych.data.get().last(2).values()[0].difference
            if (trial_contrast === 0) {
                if (jsPsych.currentTrial().contrast_left > jsPsych.currentTrial().contrast_right) {
                  mu_1.x = 100; //left
                }
                else {
                  mu_1.x = 305; //right
                }
            }
            else {
                if (jsPsych.currentTrial().contrast_left > jsPsych.currentTrial().contrast_right) {
                  mu_1.x = 305; // right
                }
                else {
                  mu_1.x = 100; //left
               }
            }
      },
      prompt: function () {
        var con_left = avgcon + jsPsych.data.get().last(2).values()[0].difference
        var con_right =  avgcon - jsPsych.data.get().last(2).values()[0].difference
        var trial_contrast = jsPsych.data.get().last(3).values()[0].contrast
        if (trial_contrast === 0) {
          if (con_left > con_right) {
              return `<p> If you choose the image on your <strong> left</strong>, what do you think is the chance of winning a reward? </p>  `
            }
            else {
              return `<p> If you choose the image on your <strong> right</strong>, what do you think is the chance of winning a reward? </p>  `
            }
        }
        else {
          if (con_left > con_right) {
              return `<p> If you choose the image on your <strong> right</strong>, what do you think is the chance of winning a reward? </p>  `
            }
            else {
              return `<p> If you choose the image on your <strong> left</strong>, what do you think is the chance of winning a reward? </p>  `
          }
        }
        },
      on_finish: function (data) {
            data.contrast_left = jsPsych.currentTrial().contrast_left // stores the contrast level of left patch on this trial
            data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
            index_mu = index_mu + 1;
            data.state = s[index_mu]
        }
    };
var mu_wait_1 = { // slider with no prticipant responses allowed for incongruent slider trial i.e. the less rewarded patch in the trial phase is used for mu estimates
    type: 'canvas-slider-response',
    canvas_size: [300, 500],
    data: {condition: 'mu_incongruent_wait'},
    stimulus: gabor_mu_wait,
    response_ends_trial: false,
    require_movement: true,
    trial_duration: 1500,
    labels: ['0%','25%', '50%', '75%', '100%'],
    on_start: function(mu_wait_1) {
        document.body.style.cursor = "auto";
        var trial_contrast = jsPsych.data.get().last(2).values()[0].contrast
        mu_wait_1.contrast_left = avgcon + jsPsych.data.get().last(1).values()[0].difference // calculate the contrast for the left gabor based on this trial's difference
        mu_wait_1.contrast_right  = avgcon - jsPsych.data.get().last(1).values()[0].difference
        if (trial_contrast === 0) {
            if (jsPsych.currentTrial().contrast_left > jsPsych.currentTrial().contrast_right) {
                mu_wait_1.x = 100; //right
            }
            else {
                mu_wait_1.x = 305; //left
            }
        }
        else {
            if (jsPsych.currentTrial().contrast_left > jsPsych.currentTrial().contrast_right) {
                mu_wait_1.x = 305; // left
            }
            else {
                mu_wait_1.x = 100; //right
            }
        }
    },
    on_load: function () {
        var slider = document.getElementsByTagName('input')[0];
        slider.disabled = true;
    },
    prompt: function () {
        var con_left = avgcon + jsPsych.data.get().last(1).values()[0].difference
        var con_right =  avgcon - jsPsych.data.get().last(1).values()[0].difference
        var trial_contrast = jsPsych.data.get().last(2).values()[0].contrast
        if (trial_contrast === 0) {
            if (con_left > con_right) {
                return `<p> If you choose the image on your <strong> left</strong>, what do you think is the chance of winning a reward? </p>  `
            }
            else {
                return `<p> If you choose the image on your <strong> right</strong>, what do you think is the chance of winning a reward? </p> `
            }
        }
        else {
            if (con_left > con_right) {
                return `<p> If you choose the image on your <strong> right</strong>, what do you think is the chance of winning a reward? </p> `
            }
            else {
                return `<p> If you choose the image on your <strong> left</strong>, what do you think is the chance of winning a reward? </p> `
            }
        }
    },
    on_finish: function (data) {
        data.contrast_left = jsPsych.currentTrial().contrast_left // stores the contrast level of left patch on this trial
        data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
    }
};
var mu_wait = { // slider with no participant responses allowed for congruent slider trial i.e. the more rewarded patch in the trial phase is used for mu estimates
    type: 'canvas-slider-response',
    canvas_size: [300, 500],
    data: {condition: 'mu_congruent_wait'},
    stimulus: gabor_mu_wait,
    response_ends_trial: false,
    require_movement: true,
    trial_duration: 1500,
    labels: ['0%','25%', '50%', '75%', '100%'],
    on_start: function(mu_wait) {
        document.body.style.cursor = "auto";
        var trial_contrast = jsPsych.data.get().last(2).values()[0].contrast
        mu_wait.contrast_left = avgcon + jsPsych.data.get().last(1).values()[0].difference // calculate the contrast for the left gabor based on this trial's difference
        mu_wait.contrast_right  = avgcon - jsPsych.data.get().last(1).values()[0].difference
        if (trial_contrast === 0) {
            if (jsPsych.currentTrial().contrast_left > jsPsych.currentTrial().contrast_right) {
                mu_wait.x = 305; //right patch
            }
            else {
                mu_wait.x = 100; //left patch
            }
        }
        else {
            if (jsPsych.currentTrial().contrast_left > jsPsych.currentTrial().contrast_right) {
                mu_wait.x = 100; // left patch
            }
            else {
                mu_wait.x = 305; //right patch
            }
        }
    },
    on_load: function () { // to disable the slider for the wait period
        var slider = document.getElementsByTagName('input')[0];
        slider.disabled = true;
    },
    prompt: function () {
        var con_left = avgcon + jsPsych.data.get().last(1).values()[0].difference
        var con_right =  avgcon - jsPsych.data.get().last(1).values()[0].difference
        var trial_contrast = jsPsych.data.get().last(2).values()[0].contrast
        if (trial_contrast === 0) {
            if (con_left > con_right) {
                return `<p> If you choose the image on your <strong> right</strong>, what do you think is the chance of winning a reward? </p>  `
            }
            else {
                return `<p> If you choose the image on your <strong> left</strong>, what do you think is the chance of winning a reward? </p> `
            }
        }
        else {
            if (con_left > con_right) {
                return `<p> If you choose the image on your <strong> left</strong>, what do you think is the chance of winning a reward? </p> `
            }
            else {
                return `<p> If you choose the image on your <strong> right</strong>, what do you think is the chance of winning a reward? </p> `
            }
        }
    },
    on_finish: function (data) {
        data.contrast_left = jsPsych.currentTrial().contrast_left// stores the contrast level of left patch on this trial
        data.contrast_right = jsPsych.currentTrial().contrast_right // stores the contrast level of right patch on this trial
    }
};

var fb_missed = { // same as var fb but feedback for missed trials
        type: "html-keyboard-response", choices: jsPsych.NO_KEYS, trial_duration: duration, data: {condition: 'feedback_missed'},
        stimulus: function () {
            var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
            if (last_trial_correct) {
                return "<p style=\"font-size: 30px;color: #016901; position: relative; top: 20px; left: -5px;\">You win 1 point!</p>";
            } else {
                return "<p style=\"font-size: 30px;color: #ba0000; position: relative; top: 20px; left: -5px;\">You win 0 points!</p>"
            }
        },
        on_finish: function(data) {
          data.index = index_missed; // index starts at 0
          var blocktype = jsPsych.data.get().last(2).values()[0].block
          if ( blocktype === 1 || blocktype === 2) {
            if (s_mu[data.index] === 0) { // state that the trial belongs to
                data.difference = -0.15 // contrast differences for s = 0
            }
            else {
                data.difference = 0.15
            }
          }
          else {
              if (s_mu[data.index] === 0) { // state that the trial belongs to
                data.difference = -0.45// contrast differences for s = 0
              }
              else {
                data.difference = 0.45
              }
            }
          
          data.contrast_left = avgcon + data.difference // calculate the contrast for the left gabor based on this trial's difference
          data.contrast_right  = avgcon - data.difference
        }
    };

var missed_trial = { // missed trial
        type: 'canvas-keyboard-multiple-response', //jsPsych trial type
        stimulus: gabor, // gabor drawn based on function
        data: {condition: 'missed'}, // condition of this trial
        choices: keys, response_ends_trial: false, trial_duration: duration,
        on_start: function(missed_trial) { // This part takes the first elements of the feedback and contrast parameters of the first missed trial.
            document.body.style.cursor = "none";
            missed_trial.missed_reward = missed_fb.shift() // stores the feedback for the first missed trial in the missed trial array
            missed_trial.contrast_left = missed_con.shift(); // stores the left contrast level for the first missed trial in the missed trial array
            missed_trial.contrast_right = missed_con1.shift(); // stores the right contrast level for the first missed trial in the missed trial array
            missed_trial.contrast = missed_contrast.shift(); // stores the correct contrast for the first missed trial in the missed trial array
            missed_trial.block = missed_block.shift() // stores the correct block type for the first missed trial in the missed trial array
        },
        on_finish: function (data) {
            var response = data.response
            var length = response.length
            if (data.response[length-1] === jsPsych.currentTrial().missed_reward) {
                data.correct = true;
                missed.pop(); // Once the missed trial has been repeated and the participant has responded, the length of the missed array has to be reduced by 1.
            } else if (length === 0) { // if the participant misses the missed trial
                missed.pop()
                missed.unshift(1) // Adds to the missed array when the participant fails to respond to a repeated trial.
                missed_fb.unshift(jsPsych.currentTrial().missed_reward)
                missed_con.unshift(jsPsych.currentTrial().contrast_left)
                missed_con1.unshift(jsPsych.currentTrial().contrast_right)
                missed_block.unshift(jsPsych.currentTrial().block)
                missed_contrast.unshift(jsPsych.currentTrial().contrast)
            }
            else {
                data.correct = false;
                missed.pop() // Once the missed trial has been repeated and the participant has responded, the length of the missed array has to be reduced by 1.
            }
            data.block = jsPsych.currentTrial().block
            data.contrast = jsPsych.currentTrial().contrast
            data.diff = jsPsych.currentTrial().difference // contrast difference
            data.corr_resp = jsPsych.currentTrial().missed_reward // Stores the correct response on the said trial.
            data.contrast_left = jsPsych.currentTrial().contrast_left // Stores the contrast of the left patch on the said trial.
            data.contrast_right = jsPsych.currentTrial().contrast_right // Stores the contrast of the rightt patch on the said trial.
            trialcounter = trialcounter + 6 // increases the trial counter to include fixation, actual trial and feedback. Thus, increases the counter by 3.
            data.stim = missed.length
            data.tcount = trialcounter
        },
    };
var missed_mixed = {timeline: [fix, missed_trial, fb_missed, mu_wait, mu, enter_trial], repetitions: 1} //full trial procedure of a missed trial
var missed_loop = {   // Runs the loop till the missed array has elements. Stops when the missed array is empty.
        timeline: [missed_mixed],
        loop_function: function() {
            if (missed.length === 0) {
                return false;
            } else {
                return true;
            }
        },
    };
var missed_conditional = { // first runs the conditional to check if the missed array has any elements. Will skip the missed_loop entirely if the participant has missed no trials in that block.
        timeline: [missed_loop],
        conditional_function: function() {
            if (missed.length > 0) { // Checks the length of the missed array. Will run the missed_loop only if the participant has missed any trials.
                return true;
            } else {
                return false;
            }
        }
    };
var missed_mixed_1 = {timeline: [fix, missed_trial, fb_missed, mu_wait_1, mu_1, enter_trial], repetitions: 1} //full trial procedure of a missed trial
var missed_loop_1 = {   // Runs the loop till the missed array has elements. Stops when the missed array is empty.
        timeline: [missed_mixed_1],
        loop_function: function() {
            if (missed.length === 0) {
                return false;
            } else {
                return true;
            }
        },
    };
var missed_conditional_1 = { // first runs the conditional to check if the missed array has any elements. Will skip the missed_loop entirely if the participant has missed no trials in that block.
        timeline: [missed_loop_1],
        conditional_function: function() {
            if (missed.length > 0) { // Checks the length of the missed array. Will run the missed_loop only if the participant has missed any trials.
                return true;
            } else {
                return false;
            }
        }
    };       
var trial_perceptual = {timeline: [fix, perceptual, fb, mu_wait, mu, enter_trial], repetitions: 25, randomize_order: false};
var trial_perceptual_1 = {timeline: [fix, perceptual_1, fb, mu_wait, mu, enter_trial], repetitions: 25, randomize_order: false};
var trial_reward = {timeline: [fix, reward, fb, mu_wait,mu, enter_trial], repetitions: 25, randomize_order: false};
var trial_reward_1 = {timeline: [fix, reward_1, fb, mu_wait,mu, enter_trial], repetitions: 25, randomize_order: false};
var trial_mixed = {timeline: [fix, mixed, fb, mu_wait,mu, enter_trial], repetitions: 25, randomize_order: false};
var trial_mixed_1 = {timeline: [fix, mixed_1, fb, mu_wait,mu, enter_trial], repetitions: 25, randomize_order: false};
    
var trial_perceptual_mu_1 = {timeline: [fix, perceptual, fb, mu_wait_1, mu_1, enter_trial], repetitions: 25, randomize_order: false};
var trial_perceptual_1_mu_1 = {timeline: [fix, perceptual_1, fb, mu_wait_1, mu_1, enter_trial], repetitions: 25, randomize_order: false};
var trial_reward_mu_1 = {timeline: [fix, reward, fb, mu_wait_1, mu_1, enter_trial], repetitions: 25, randomize_order: false};
var trial_reward_1_mu_1 = {timeline: [fix, reward_1, fb, mu_wait_1, mu_1, enter_trial], repetitions: 25, randomize_order: false};
var trial_mixed_mu_1 = {timeline: [fix, mixed, fb, mu_wait_1, mu_1, enter_trial], repetitions: 25, randomize_order: false};
var trial_mixed_1_mu_1 = {timeline: [fix, mixed_1, fb, mu_wait_1, mu_1, enter_trial], repetitions: 25, randomize_order: false};

var block1 = {timeline: [trial_perceptual, missed_conditional, score], repetitions: 1};
var block2 = {timeline: [trial_perceptual_1, missed_conditional, score], repetitions: 1};
var block3 = {timeline: [trial_reward, missed_conditional, score], repetitions: 1};
var block4 = {timeline: [trial_reward_1, missed_conditional, score], repetitions: 1};
var block5 = {timeline: [trial_mixed, missed_conditional, score], repetitions: 1};
var block6 = {timeline: [trial_mixed_1, missed_conditional, score], repetitions: 1};
    
var block7 = {timeline: [trial_perceptual_mu_1, missed_conditional_1, score], repetitions: 1};
var block8 = {timeline: [trial_perceptual_1_mu_1, missed_conditional_1, score], repetitions: 1};
var block9 = {timeline: [trial_reward_mu_1, missed_conditional_1, score], repetitions: 1};
var block10 = {timeline: [trial_reward_1_mu_1, missed_conditional_1, score], repetitions: 1};
var block11 = {timeline: [trial_mixed_mu_1, missed_conditional_1, score], repetitions: 1};
var block12 = {timeline: [trial_mixed_1_mu_1, missed_conditional_1, score], repetitions: 1};

var start = {timeline: [welcome, survey_id]};
var blockarray = [block1,  block7, block6, block5, block4, block3, block2, block8, block9, block10, block11, block12];
var blocks_shuffled = jsPsych.randomization.shuffle(blockarray); // first set of blocks
var block_1 = blocks_shuffled[0]; var block_2 = blocks_shuffled[1]; var block_3 = blocks_shuffled[2]; var block_4 = blocks_shuffled[3]; 
var block_5 = blocks_shuffled[4]; var block_6 = blocks_shuffled[5]; var block_7 = blocks_shuffled[6]; var block_8 = blocks_shuffled[7];
var block_9 = blocks_shuffled[8]; var block_10 = blocks_shuffled[9]; var block_11 = blocks_shuffled[10]; var block_12 = blocks_shuffled[11];

timeline.push(start)
timeline.push(firstblock)
timeline.push(block_1); timeline.push(nextblock); timeline.push(block_2); timeline.push(nextblock); timeline.push(block_3); timeline.push(nextblock);
timeline.push(block_4); timeline.push(nextblock); timeline.push(block_5); timeline.push(nextblock); timeline.push(block_6); timeline.push(nextblock);
timeline.push(block_7); timeline.push(nextblock); timeline.push(block_8); timeline.push(nextblock); timeline.push(block_9); timeline.push(nextblock);
timeline.push(block_10); timeline.push(nextblock); timeline.push(block_11); timeline.push(nextblock); timeline.push(block_12); 
//timeline.push(debriefing)
timeline.push(completion_id)
jsPsych.init({
        timeline: timeline,
    });
</script>
</html>
